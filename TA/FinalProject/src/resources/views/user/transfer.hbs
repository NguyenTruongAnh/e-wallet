<div class="dashboard-wrapper">
    <div class="container-fluid  dashboard-content">
        <div class="row">
            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                <div class="page-header">
                    <h2 class="pageheader-title"><i class="fa-solid fa-money-bill-transfer"></i> Chuyển tiền </h2>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-12">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <form id="user-transfer__form-info" class="needs-validation" novalidate>
                                    <div class="row">
                                        {{!-- Input số điện thoại người nhận --}}
                                        <div class="col-md-6 mb-2">
                                            <label for="user-transfer__form-info-phone">Số điện thoại người
                                                nhận:</label>
                                            <input id="user-transfer__form-info-phone" type="number"
                                                class="form-control" placeholder="Nhập số điện thoại người nhận"
                                                required />
                                            <div class="invalid-feedback">
                                                Vui lòng nhập số điện thoại
                                            </div>
                                            <p class="d-none text-danger" id="user-transfer__form-info-phone-invalid">
                                                Số điện thoại không hợp lệ</p>
                                        </div>

                                        {{!-- Input số tiền cần chuyển --}}
                                        <div class="col-md-6 mb-2">
                                            <label for="user-transfer__form-info-money">Số tiền chuyển:</label>
                                            <input id="user-transfer__form-info-money" type="number"
                                                class="form-control" placeholder="Nhập số tiền cần chuyển" required />
                                            <div class="invalid-feedback">
                                                Vui lòng nhập số tiền cần chuyển
                                            </div>
                                            <p class="d-none text-danger" id="user-transfer__form-info-money-invalid">
                                                Số tiền tối thiểu từ 1.000đ</p>
                                        </div>

                                        {{!-- Input ghi chú --}}
                                        <div class="col-md-12 mb-2">
                                            <label for="user-transfer__form-info-note">Ghi chú:</label>
                                            <textarea name="" id="user-transfer__form-info-note" class="w-100 px-2"
                                                cols="30" placeholder="Ghi chú"></textarea>
                                        </div>

                                        {{!-- Input phí chuyển tiền --}}
                                        <div class="col-md-12 mb-2">
                                            Phí giao dịch: <span id="user-transfer__form-info-fee">0đ</span> (5%
                                            số
                                            tiền chuyển khoản)
                                        </div>

                                        {{!-- Checkbox người nhận trả phí --}}
                                        <div class="col-md-12 mb-2">
                                            <input type="checkbox" id="user-transfer__form-info-checked">
                                            <label class="form-check-label" for="user-transfer__form-info-checked">
                                                Người nhận trả phí
                                            </label>
                                        </div>

                                        <div class="col-12">
                                            <div class="d-flex justify-content-end">
                                                <button type="submit" id="user-transfer__form-info-btn"
                                                    class="btn btn-space btn-success">Xác
                                                    nhận</button>
                                            </div>
                                        </div>

                                        <div id="user-transfer__form-info-loader"
                                            class="col-12 d-none justify-content-center">
                                            <div class="loader"></div>
                                        </div>
                                    </div>
                                </form>

                                <form id="user-transfer__form-confirm" class="needs-validation d-none" novalidate>
                                    <div class="row">
                                        {{!-- Input tên người nhận --}}
                                        <div class="col-md-6 mb-2">
                                            <label for="user-transfer__form-confirm-name">Tên người nhận:</label>
                                            <input id="user-transfer__form-confirm-name" type="text"
                                                class="form-control" placeholder="Nhập số điện thoại người nhận"
                                                disabled />
                                        </div>

                                        {{!-- Input mã OTP --}}
                                        <div class="col-md-6 mb-2">
                                            <label for="user-transfer__form-confirm-otp">Nhập mã OTP:</label>
                                            <input id="user-transfer__form-confirm-otp" type="text" class="form-control"
                                                placeholder="Nhập mã OTP" required />
                                            <div class="invalid-feedback">
                                                Vui lòng nhập mã OTP
                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="d-flex justify-content-end">
                                                <button type="submit" class="btn btn-space btn-success">Chuyển
                                                    tiền</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{!-- Modal message --}}
<div id="transfer-modal-message" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thông báo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="transfer-modal-body__message"></p>
            </div>
            <div class="modal-footer">
                <button id="recovery2-modal-btn" type="button" class="btn btn-success" data-dismiss="modal">Xác
                    nhận</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const userTransferInfoForm = document.getElementById("user-transfer__form-info")

        const userTransferInfoInputPhone = $('#user-transfer__form-info-phone')
        const userTransferInfoInputMoney = $('#user-transfer__form-info-money')
        const userTransferInfoInputNote = $('#user-transfer__form-info-note')
        const userTransferInfoFee = $('#user-transfer__form-info-fee')
        const userTransferInfoBtn = $('#user-transfer__form-info-btn')

        const userTransferInfoLoader = $('#user-transfer__form-info-loader')

        const transferModalMessage = $('#transfer-modal-message')
        const transferModalBodyMessage = $('#transfer-modal-body__message')

        let userTransferInfoPhone = false // Dùng kiểm tra phone hợp lệ chưa
        let userTransferInfoMoney = false // Dùng kiểm tra số tiền có hợp lệ chưa

        const userTransferConfirmForm = document.getElementById("user-transfer__form-confirm")

        let transferTransactionId
        let isReloadTransferPage = false

        //* Xử lý Form Info */
        // Sự kiện gửi form lên
        userTransferInfoForm.addEventListener('submit', function (event) {
            event.preventDefault()
            event.stopPropagation()
            if (userTransferInfoForm.checkValidity() === false) {
                userTransferInfoForm.classList.add('was-validated')
            } else {
                userTransferInfoForm.classList.remove('was-validated')

                if (userTransferInfoPhone && userTransferInfoMoney) {
                    // Bật nút loader lên và ẩn nút gửi đi
                    userTransferInfoLoader.removeClass('d-none')
                    userTransferInfoLoader.addClass('d-flex')
                    userTransferInfoBtn.addClass('d-none')

                    // Set timeout để có thời gian để thực hiện biến đổi giao diện
                    setTimeout(function () {
                        const receiverPhone = userTransferInfoInputPhone.val()
                        const amount = parseInt(userTransferInfoInputMoney.val())
                        const note = userTransferInfoInputNote.val()
                        const whoPayFee = $('#user-transfer__form-info-checked').is(':checked') ? 1 : 0
                        const fee = amount * 0.05

                        const transferData = {
                            receiverPhone,
                            amount,
                            note,
                            whoPayFee,
                            fee
                        }

                        $.ajax({
                            url: "http://localhost:3000/transfer",
                            type: "POST",
                            data: transferData,
                            async: false,
                            success: function (result) {
                                userTransferInfoLoader.removeClass('d-flex')
                                userTransferInfoLoader.addClass('d-none')
                                userTransferInfoBtn.removeClass('d-none')

                                // Trường hợp gửi thành công
                                if (result.code === 0) {
                                    // Vô hiệu việc nhập các trường sđt, số tiền chuyển, note và checkbox
                                    // Ẩn nút xác nhận
                                    // Hiển thị tên người được nhận và nút chuyển tiền
                                    userTransferInfoBtn.addClass('d-none')
                                    userTransferConfirmForm.classList.remove('d-none')
                                    userTransferInfoInputPhone.attr('readonly', true)
                                    userTransferInfoInputMoney.attr('readonly', true)
                                    userTransferInfoInputNote.attr('readonly', true)
                                    $('#user-transfer__form-info-checked').attr('disabled', true)

                                    // Hiển thị tên người nhận tiền
                                    $('#user-transfer__form-confirm-name').val(result.data.receiverName)

                                    // Gán mã giao dịch vừa được tạo
                                    transferTransactionId = result.data.transactionId
                                }

                                // Trường hợp gặp lỗi hệ thống
                                if (result.code === 2) {
                                    isReloadTransferPage = true
                                }

                                transferModalBodyMessage.html(result.message)
                                transferModalMessage.modal('show')
                            }
                        })
                    }, 1000)
                }
            }
        }, false)

        // Bắt sự kiện nhập số điện thoại người nhận
        userTransferInfoInputPhone.change(function () {
            const value = userTransferInfoInputPhone.val()

            if (!checkPhoneNumber(value)) {
                $('#user-transfer__form-info-phone-invalid').removeClass('d-none')
                userTransferInfoPhone = false
            } else {
                $('#user-transfer__form-info-phone-invalid').addClass('d-none')
                userTransferInfoPhone = true
            }
        })

        // Bắt sự kiện nhập số tiền
        userTransferInfoInputMoney.change(function () {
            const value = parseInt(userTransferInfoInputMoney.val())

            if (!value || value < 1000) {
                $('#user-transfer__form-info-money-invalid').removeClass('d-none')
                userTransferInfoMoney = false
            } else {
                $('#user-transfer__form-info-money-invalid').addClass('d-none')
                userTransferInfoMoney = true

                // Tính phí gửi 
                userTransferInfoFee.text(`${formatMoney(value * 0.05)}đ`)
            }
        })

        // Sự kiện modal message đóng
        transferModalMessage.on('hidden.bs.modal', function () {
            if (isReloadTransferPage) {
                window.location.reload()
            }
        })

        //** Xử lý Form Confirm */
        userTransferConfirmForm.addEventListener('submit', function (event) {
            event.preventDefault()
            event.stopPropagation()
            if (userTransferConfirmForm.checkValidity() === false) {
                userTransferConfirmForm.classList.add('was-validated')
            } else {
                userTransferConfirmForm.classList.remove('was-validated')

                const otpCode = $('#user-transfer__form-confirm-otp').val()

                $.ajax({
                    url: 'http://localhost:3000/transfer-confirm',
                    method: 'POST',
                    data: {
                        transactionId: transferTransactionId,
                        otpCode: otpCode
                    },
                    async: false,
                    success: function (result) {
                        if (result.code !== 1) {
                            isReloadTransferPage = true
                        }

                        transferModalBodyMessage.html(result.message)
                        transferModalMessage.modal('show')
                    }
                })

            }
        }, false)


        // Kiểm tra số điện thoại
        function checkPhoneNumber(phone) {
            return /(03|05|07|08|09|01[2|6|8|9])+([0-9]{8})\b/.test(phone)
        }

        // Format tiền
        function formatMoney(a) {
            const formatter = new Intl.NumberFormat('vi-VN')

            return formatter.format(a)
        }
    })
</script>